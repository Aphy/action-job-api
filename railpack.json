{
  "$schema": "https://schema.railpack.com",

  "steps": {
    "install": {
      "inputs": [
        { "include": ["."] },
        { "image": "composer:2" }
      ],
      "commands": [
        { "cmd": "composer install --working-dir=/app/api --no-dev --prefer-dist --no-interaction --optimize-autoloader --no-scripts -vvv" }
      ],
      "deployOutputs": [
        { "include": ["/app/api/vendor"] }
      ]
    },

    "build": {
      "inputs": [
        { "step": "install" }
      ],
      "commands": [],
      "deployOutputs": [
        { "include": ["."] }
      ]
    },

    "migrate": {
      "inputs": [
        { "step": "build" }
      ],
      "commands": [
        {
          "cmd": "sh -lc 'i=0; until php -r \"try{ new PDO(getenv(\\\"DATABASE_URL\\\")); exit(0);}catch(Throwable $e){ exit(1);}\"; do i=$((i+1)); [ $i -ge 60 ] && echo \"DB not ready after timeout\" && exit 1; echo \"DB not readyâ€¦ ($i)\"; sleep 2; done'"
        },
        { "cmd": "php /app/api/bin/console doctrine:database:create --if-not-exists --no-interaction" },
        { "cmd": "php /app/api/bin/console doctrine:migrations:migrate --no-interaction --allow-no-migration" },
        { "cmd": "php /app/api/bin/console cache:warmup --env=prod" }
      ],
      "deployOutputs": [
        { "include": ["."] }
      ]
    }
  },

  "deploy": {
    "inputs": [
      { "step": "migrate" }
    ],
    "variables": {
      "APP_ENV": "prod",
      "RAILPACK_PHP_ROOT_DIR": "api/public"
    }
  }
}
