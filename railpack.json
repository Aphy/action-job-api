{
  "$schema": "https://schema.railpack.com",

  "packages": { "php": "8.3" },

  "steps": {
    "install": {
      "commands": [
        "composer install --working-dir=api --no-dev --prefer-dist --no-interaction --optimize-autoloader --no-scripts -vvv"
      ]
    },

    "build": {
      "inputs": [
        { "step": "install" }
      ],
      "commands": []
    },

    "migrate": {
      "inputs": [
        { "step": "build" }
      ],
      "commands": [
        "sh -lc 'i=0; until php -r \"try{ new PDO(getenv(\\\"DATABASE_URL\\\")); exit(0);}catch(Throwable $e){ exit(1);}\"; do i=$((i+1)); [ $i -ge 60 ] && echo \"DB not ready after timeout\" && exit 1; echo \"DB not readyâ€¦ ($i)\"; sleep 2; done'",
        "php /app/api/bin/console doctrine:database:create --if-not-exists --no-interaction",
        "php /app/api/bin/console doctrine:migrations:migrate --no-interaction --allow-no-migration",
        "php /app/api/bin/console cache:warmup --env=prod"
      ]
    }
  },

  "deploy": {
    "base": { "image": "ghcr.io/railwayapp/railpack-runtime:latest" },
    "inputs": [
      { "step": "migrate" }
    ],
    "variables": {
      "APP_ENV": "prod",
      "RAILPACK_PHP_ROOT_DIR": "api/public"
    },
    "startCommand": "/start-container.sh"
  }
}
